[
    {
        "id": "2a36b650.4b9b7a",
        "type": "tab",
        "label": "8-cards",
        "disabled": false,
        "info": ""
    },
    {
        "id": "60dcbb9f.c0dfa4",
        "type": "debug",
        "z": "2a36b650.4b9b7a",
        "name": "cards",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 450,
        "y": 180,
        "wires": []
    },
    {
        "id": "78c4fc48.bc5bf4",
        "type": "ui_text",
        "z": "2a36b650.4b9b7a",
        "group": "573f9bfa.7e4564",
        "order": 13,
        "width": 4,
        "height": 1,
        "name": "cards",
        "label": "records",
        "format": "{{msg.payload.cards}}",
        "layout": "row-spread",
        "x": 450,
        "y": 220,
        "wires": []
    },
    {
        "id": "b8460bf9.4811f8",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "refresh",
        "links": [
            "fbd6b7a7.cd1af8",
            "46cebfa2.e38c6"
        ],
        "x": 135,
        "y": 220,
        "wires": [
            [
                "4f2ad0e3.4c05e"
            ]
        ]
    },
    {
        "id": "4f2ad0e3.4c05e",
        "type": "get-cards",
        "z": "2a36b650.4b9b7a",
        "name": "get-cards",
        "config": "cbd92359.dbf19",
        "x": 280,
        "y": 220,
        "wires": [
            [
                "78c4fc48.bc5bf4",
                "60dcbb9f.c0dfa4"
            ]
        ]
    },
    {
        "id": "6ce7f877.625e48",
        "type": "get-card",
        "z": "2a36b650.4b9b7a",
        "name": "get-card",
        "config": "cbd92359.dbf19",
        "x": 460,
        "y": 500,
        "wires": [
            [
                "4ce6edf2.3af724"
            ],
            [
                "75f21b8.86ccbe4",
                "f6808502.b5c9e8"
            ]
        ]
    },
    {
        "id": "f6808502.b5c9e8",
        "type": "debug",
        "z": "2a36b650.4b9b7a",
        "name": "card",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 650,
        "y": 560,
        "wires": []
    },
    {
        "id": "92910a57.c53858",
        "type": "ui_dropdown",
        "z": "2a36b650.4b9b7a",
        "name": "controller",
        "label": "",
        "tooltip": "",
        "place": "<select controller>",
        "group": "975ca31.d8d236",
        "order": 1,
        "width": 6,
        "height": 1,
        "passthru": true,
        "multiple": false,
        "options": [],
        "payload": "",
        "topic": "set-device",
        "x": 120,
        "y": 380,
        "wires": [
            [
                "fe2f6f7f.53fd9"
            ]
        ]
    },
    {
        "id": "6277cd72.6d7ea4",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "card",
        "func": "switch (msg.topic) {\n    case 'set-device':\n        flow.set('get-card.device', msg.payload)\n        break;\n\n    case 'set-card-number':\n        flow.set('get-card.cardnumber', msg.payload)\n        break;\n}\n\nconst deviceId = flow.get('get-card.device')\nconst cardNumber = flow.get('get-card.cardnumber')\n\nif (deviceId && cardNumber) {\n    msg.payload = { \n        deviceId: deviceId,\n        cardNumber: cardNumber\n    }\n        \n    return msg\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 270,
        "y": 500,
        "wires": [
            [
                "6ce7f877.625e48"
            ]
        ]
    },
    {
        "id": "52a5b4e7.d2590c",
        "type": "ui_text",
        "z": "2a36b650.4b9b7a",
        "group": "80ebf5dd.1d2018",
        "order": 5,
        "width": 5,
        "height": 1,
        "name": "card.status",
        "label": "",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1050,
        "y": 740,
        "wires": []
    },
    {
        "id": "75f21b8.86ccbe4",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "retrieved",
        "func": "card = msg.payload.card\nmsg.payload = card\n\nreturn msg\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 660,
        "y": 520,
        "wires": [
            [
                "ed03620e.d9ff",
                "e7671a59.2c71c8"
            ]
        ]
    },
    {
        "id": "7fe3bec1.b4483",
        "type": "put-card",
        "z": "2a36b650.4b9b7a",
        "name": "put-card",
        "config": "cbd92359.dbf19",
        "x": 1420,
        "y": 320,
        "wires": [
            [
                "6a069f42.59c15",
                "8194bf5e.b9a13"
            ]
        ]
    },
    {
        "id": "6a069f42.59c15",
        "type": "debug",
        "z": "2a36b650.4b9b7a",
        "name": "stored",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1590,
        "y": 280,
        "wires": []
    },
    {
        "id": "9caadcc7.b679f",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "card",
        "func": "const format = (n, l) => String(n).padStart(l, '0')\nconst yyyymmdd = (d) => {\n    const year = format(d.getFullYear(), 4)\n    const month = format(d.getMonth()+1, 2)\n    const day = format(d.getDate(), 2)\n    \n    return year + '-' + month + '-' + day\n}\n\nswitch (msg.topic) {\n    case 'set-device':\n        flow.set('put-card.device', msg.payload)\n        break\n\n    case 'set-card-number':\n        flow.set('put-card.card.number', msg.payload)\n        break\n\n    case 'set-card-valid-from':\n        flow.set('put-card.card.valid.from', yyyymmdd(new Date(msg.payload)))\n        break\n\n    case 'set-card-valid-to':\n        flow.set('put-card.card.valid.to', yyyymmdd(new Date(msg.payload)))\n        break\n\n    case 'set-card-doors-1':\n        flow.set('put-card.card.doors.1', msg.payload)\n        break    \n\n    case 'set-card-doors-2':\n        flow.set('put-card.card.doors.2', msg.payload)\n        break    \n\n    case 'set-card-doors-3':\n        flow.set('put-card.card.doors.3', msg.payload)\n        break    \n\n    case 'set-card-doors-4':\n        flow.set('put-card.card.doors.4', msg.payload)\n        break    \n        \n    case 'put-card':\n        const deviceId = flow.get('put-card.device')\n        const cardNumber = flow.get('put-card.card.number')\n        const validFrom = flow.get('put-card.card.valid.from')\n        const validTo = flow.get('put-card.card.valid.to')\n        const door1 = flow.get('put-card.card.doors.1')\n        const door2 = flow.get('put-card.card.doors.2')\n        const door3 = flow.get('put-card.card.doors.3')\n        const door4 = flow.get('put-card.card.doors.4')\n\n        console.log(deviceId, cardNumber, validFrom, validTo)\n        \n        if (deviceId && cardNumber && validFrom && validTo) {\n            msg.payload = { \n                deviceId: deviceId,\n                card: {\n                    number: cardNumber,\n                    valid: {\n                        from: validFrom,\n                        to: validTo\n                    },\n                    doors: {\n                        \"1\": door1 || false,\n                        \"2\": door2 || false,\n                        \"3\": door3 || false,\n                        \"4\": door4 || false\n                    }\n                }\n            }\n        \n            return msg\n        }\n        break\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1250,
        "y": 320,
        "wires": [
            [
                "7fe3bec1.b4483"
            ]
        ]
    },
    {
        "id": "46db6d43.a9d444",
        "type": "ui_text_input",
        "z": "2a36b650.4b9b7a",
        "name": "card.number",
        "label": "card number",
        "tooltip": "",
        "group": "80ebf5dd.1d2018",
        "order": 3,
        "width": 6,
        "height": 1,
        "passthru": false,
        "mode": "number",
        "delay": "0",
        "topic": "set-card-number",
        "x": 110,
        "y": 420,
        "wires": [
            [
                "cb6b878.02d9b78"
            ]
        ]
    },
    {
        "id": "83c1860b.02d9f8",
        "type": "ui_text",
        "z": "2a36b650.4b9b7a",
        "group": "80ebf5dd.1d2018",
        "order": 7,
        "width": 1,
        "height": 1,
        "name": "label-from",
        "label": "from",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1050,
        "y": 380,
        "wires": []
    },
    {
        "id": "70cb34bc.8def6c",
        "type": "ui_text",
        "z": "2a36b650.4b9b7a",
        "group": "80ebf5dd.1d2018",
        "order": 10,
        "width": 1,
        "height": 1,
        "name": "label-to",
        "label": "to",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "x": 1060,
        "y": 420,
        "wires": []
    },
    {
        "id": "c18e5552.2e5a48",
        "type": "ui_button",
        "z": "2a36b650.4b9b7a",
        "name": "put-card",
        "group": "80ebf5dd.1d2018",
        "order": 20,
        "width": 3,
        "height": 1,
        "passthru": false,
        "label": "update",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "put-card",
        "x": 1060,
        "y": 700,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "8194bf5e.b9a13",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "stored",
        "func": "if (msg.payload.stored) {\n    msg.payload = 'card updated'\n} else {\n    msg.payload = 'error adding/updating card'\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1590,
        "y": 320,
        "wires": [
            [
                "191160b2.4d831f"
            ]
        ]
    },
    {
        "id": "e7473423.ef6728",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "card",
        "func": "switch (msg.topic) {\n    case 'set-device':\n        flow.set('delete-card.device', msg.payload)\n        break;\n\n    case 'set-card-number':\n        flow.set('delete-card.card.number', msg.payload)\n        break;\n        \n    case 'delete-card':\n        const deviceId = flow.get('delete-card.device')\n        const cardNumber = flow.get('delete-card.card.number')\n\n        if (deviceId && cardNumber) {\n            msg.payload = { \n                deviceId: deviceId,\n                cardNumber: cardNumber\n            }\n        \n            return msg\n        }\n        break        \n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 270,
        "y": 1200,
        "wires": [
            [
                "4ac01a83.a74ec4"
            ]
        ]
    },
    {
        "id": "4ac01a83.a74ec4",
        "type": "delete-card",
        "z": "2a36b650.4b9b7a",
        "name": "delete-card",
        "config": "cbd92359.dbf19",
        "x": 470,
        "y": 1200,
        "wires": [
            [
                "d35026f6.29b788",
                "aad3691e.482588"
            ]
        ]
    },
    {
        "id": "d35026f6.29b788",
        "type": "debug",
        "z": "2a36b650.4b9b7a",
        "name": "deleted",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1160,
        "wires": []
    },
    {
        "id": "e09b14f4.d89ca8",
        "type": "ui_button",
        "z": "2a36b650.4b9b7a",
        "name": "delete-card",
        "group": "80ebf5dd.1d2018",
        "order": 21,
        "width": 3,
        "height": 1,
        "passthru": false,
        "label": "delete",
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "delete-card",
        "x": 90,
        "y": 1240,
        "wires": [
            [
                "e7473423.ef6728"
            ]
        ]
    },
    {
        "id": "fe2f6f7f.53fd9",
        "type": "link out",
        "z": "2a36b650.4b9b7a",
        "name": "card-controller",
        "links": [
            "11c70f5e.08eca1",
            "36bef050.3e6b9",
            "93805387.eb6cd",
            "a74d4fc3.50b25",
            "db72adb4.36261",
            "f93335b9.2a2448",
            "51859f2a.5f682"
        ],
        "x": 275,
        "y": 380,
        "wires": []
    },
    {
        "id": "f93335b9.2a2448",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 135,
        "y": 480,
        "wires": [
            [
                "6277cd72.6d7ea4"
            ]
        ]
    },
    {
        "id": "93805387.eb6cd",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 135,
        "y": 1160,
        "wires": [
            [
                "e7473423.ef6728"
            ]
        ]
    },
    {
        "id": "cb6b878.02d9b78",
        "type": "link out",
        "z": "2a36b650.4b9b7a",
        "name": "card-number",
        "links": [
            "bd883038.dbaac",
            "129b9c14.1aba94",
            "3036418d.f8557e",
            "1fbf5878.4949c8"
        ],
        "x": 275,
        "y": 420,
        "wires": []
    },
    {
        "id": "bd883038.dbaac",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "cb6b878.02d9b78"
        ],
        "x": 135,
        "y": 520,
        "wires": [
            [
                "6277cd72.6d7ea4"
            ]
        ]
    },
    {
        "id": "129b9c14.1aba94",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "cb6b878.02d9b78"
        ],
        "x": 135,
        "y": 1200,
        "wires": [
            [
                "e7473423.ef6728"
            ]
        ]
    },
    {
        "id": "a74d4fc3.50b25",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 1075,
        "y": 300,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "3036418d.f8557e",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "cb6b878.02d9b78"
        ],
        "x": 1075,
        "y": 340,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "f8233afa.37a5c8",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "card-status",
        "links": [
            "d5de73fc.318b9",
            "b00ce9c1.ba59d8",
            "191160b2.4d831f",
            "fefda9af.f92c78"
        ],
        "x": 895,
        "y": 740,
        "wires": [
            [
                "52a5b4e7.d2590c"
            ]
        ]
    },
    {
        "id": "b00ce9c1.ba59d8",
        "type": "link out",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "f8233afa.37a5c8"
        ],
        "x": 795,
        "y": 1200,
        "wires": []
    },
    {
        "id": "aad3691e.482588",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "deleted",
        "func": "if (msg.payload.deleted) {\n    msg.payload = 'card deleted'\n} else {\n    msg.payload = 'error deleting card'\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 700,
        "y": 1200,
        "wires": [
            [
                "b00ce9c1.ba59d8"
            ]
        ]
    },
    {
        "id": "e70a1f2e.dcd39",
        "type": "ui_date_picker",
        "z": "2a36b650.4b9b7a",
        "name": "card-from",
        "label": "",
        "group": "80ebf5dd.1d2018",
        "order": 8,
        "width": 4,
        "height": 1,
        "passthru": true,
        "topic": "set-card-valid-from",
        "x": 1060,
        "y": 460,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "ed03620e.d9ff",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "valid-dates",
        "func": "const parse = function(s) {\n    const re = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/\n    const match = re.exec(s)\n    \n    if (match !== null && match.length > 3) {\n        const year = parseInt(match[1], 10)\n        const month = parseInt(match[2], 10)\n        const day = parseInt(match[3], 10)\n        const date = new Date()\n\n        date.setYear(year)\n        date.setMonth(month - 1)\n        date.setDate(day)\n        \n        return date\n    }\n    \n    return null\n}\n        \nif (msg.payload.valid) {\n    const from = parse(msg.payload.valid.from)\n    const to = parse(msg.payload.valid.to)\n    let p = null\n    let q = null\n\n    if (from !== null) {\n        p = { topic:msg.topic, payload:from }\n    }\n\n    if (to !== null) {\n        q = { topic:msg.topic, payload:to }\n    }\n\n    return [p,q]\n}\n\nreturn [null, null]\n\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 850,
        "y": 500,
        "wires": [
            [
                "e70a1f2e.dcd39"
            ],
            [
                "51e5131e.65bf4c"
            ]
        ]
    },
    {
        "id": "51e5131e.65bf4c",
        "type": "ui_date_picker",
        "z": "2a36b650.4b9b7a",
        "name": "card-to",
        "label": "",
        "group": "80ebf5dd.1d2018",
        "order": 11,
        "width": 4,
        "height": 1,
        "passthru": true,
        "topic": "set-card-valid-to",
        "x": 1060,
        "y": 500,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "191160b2.4d831f",
        "type": "link out",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "f8233afa.37a5c8"
        ],
        "x": 1715,
        "y": 320,
        "wires": []
    },
    {
        "id": "6eac8a4e.b9baf4",
        "type": "ui_switch",
        "z": "2a36b650.4b9b7a",
        "name": "card.doors.1",
        "label": "{{msg.topic}}",
        "tooltip": "",
        "group": "80ebf5dd.1d2018",
        "order": 13,
        "width": 5,
        "height": 1,
        "passthru": true,
        "decouple": "false",
        "topic": "set-card-doors-1",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "x": 1050,
        "y": 540,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "e7671a59.2c71c8",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "doors",
        "func": "if (msg.payload.doors) {\n   const controllers = flow.get('controllers')\n   const deviceId = flow.get('get-card.device')\n   const device = controllers[deviceId]\n   const doors = {\n       '1': { topic: 'door 1', payload: msg.payload.doors['1'] },\n       '2': { topic: 'door 2', payload: msg.payload.doors['2'] },\n       '3': { topic: 'door 3', payload: msg.payload.doors['3'] },\n       '4': { topic: 'door 4', payload: msg.payload.doors['4'] }\n   }\n\n   if (device && device.doors) {\n       doors[1].topic = device.doors[1]\n       doors[2].topic = device.doors[2]\n       doors[3].topic = device.doors[3]\n       doors[4].topic = device.doors[4]\n   }\n\n   return [ doors[1], doors[2], doors[3], doors[4] ]\n}\n\nreturn [ null, null, null, null ]\n\n",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 830,
        "y": 560,
        "wires": [
            [
                "6eac8a4e.b9baf4"
            ],
            [
                "9eb1f7b1.8b0968"
            ],
            [
                "34ea4d9f.8c2892"
            ],
            [
                "81c28b36.1b34e8"
            ]
        ]
    },
    {
        "id": "9eb1f7b1.8b0968",
        "type": "ui_switch",
        "z": "2a36b650.4b9b7a",
        "name": "card.doors.2",
        "label": "{{msg.topic}}",
        "tooltip": "",
        "group": "80ebf5dd.1d2018",
        "order": 15,
        "width": 5,
        "height": 1,
        "passthru": true,
        "decouple": "false",
        "topic": "set-card-doors-2",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "x": 1050,
        "y": 580,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "34ea4d9f.8c2892",
        "type": "ui_switch",
        "z": "2a36b650.4b9b7a",
        "name": "card.doors.3",
        "label": "{{msg.topic}}",
        "tooltip": "",
        "group": "80ebf5dd.1d2018",
        "order": 17,
        "width": 5,
        "height": 1,
        "passthru": true,
        "decouple": "false",
        "topic": "set-card-doors-3",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "x": 1050,
        "y": 620,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "81c28b36.1b34e8",
        "type": "ui_switch",
        "z": "2a36b650.4b9b7a",
        "name": "card.doors.4",
        "label": "{{msg.topic}}",
        "tooltip": "",
        "group": "80ebf5dd.1d2018",
        "order": 19,
        "width": 5,
        "height": 1,
        "passthru": true,
        "decouple": "false",
        "topic": "set-card-doors-4",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "",
        "oncolor": "",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "",
        "offcolor": "",
        "x": 1050,
        "y": 660,
        "wires": [
            [
                "9caadcc7.b679f"
            ]
        ]
    },
    {
        "id": "32cd75ea.8b84ba",
        "type": "ui_table",
        "z": "2a36b650.4b9b7a",
        "group": "975ca31.d8d236",
        "name": "cards",
        "order": 6,
        "width": 14,
        "height": 16,
        "columns": [
            {
                "field": "number",
                "title": "card number",
                "width": "134",
                "align": "left",
                "formatter": "plaintext",
                "formatterParams": {
                    "target": "_blank"
                }
            },
            {
                "field": "valid.from",
                "title": "from",
                "width": "108",
                "align": "left",
                "formatter": "plaintext",
                "formatterParams": {
                    "target": "_blank"
                }
            },
            {
                "field": "valid.to",
                "title": "to",
                "width": "108",
                "align": "left",
                "formatter": "plaintext",
                "formatterParams": {
                    "target": "_blank"
                }
            },
            {
                "field": "doors.1",
                "title": "entrance",
                "width": "100",
                "align": "center",
                "formatter": "tickCross",
                "formatterParams": {
                    "target": "_blank"
                }
            },
            {
                "field": "doors.2",
                "title": "workshop",
                "width": "100",
                "align": "center",
                "formatter": "tickCross",
                "formatterParams": {
                    "target": "_blank"
                }
            },
            {
                "field": "doors.3",
                "title": "tower",
                "width": "100",
                "align": "center",
                "formatter": "tickCross",
                "formatterParams": {
                    "target": "_blank"
                }
            },
            {
                "field": "doors.4",
                "title": "dungeon",
                "width": "100",
                "align": "center",
                "formatter": "tickCross",
                "formatterParams": {
                    "target": "_blank"
                }
            }
        ],
        "outputs": 0,
        "cts": false,
        "x": 1130,
        "y": 960,
        "wires": []
    },
    {
        "id": "5b79d6d.06dc728",
        "type": "ui_button",
        "z": "2a36b650.4b9b7a",
        "name": "refresh-cards",
        "group": "975ca31.d8d236",
        "order": 3,
        "width": 2,
        "height": 2,
        "passthru": false,
        "label": "refresh",
        "tooltip": "Get cards from controller",
        "color": "#008000",
        "bgcolor": "#A6BBCF",
        "icon": "fa-refresh",
        "payload": "",
        "payloadType": "str",
        "topic": "refresh",
        "x": 90,
        "y": 800,
        "wires": [
            [
                "920606cd.352758"
            ]
        ]
    },
    {
        "id": "196e0519.9c92cb",
        "type": "get-cards",
        "z": "2a36b650.4b9b7a",
        "name": "get-cards",
        "config": "cbd92359.dbf19",
        "x": 420,
        "y": 780,
        "wires": [
            [
                "a6377ea9.6a093"
            ]
        ]
    },
    {
        "id": "920606cd.352758",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "refresh",
        "func": "switch (msg.topic) {\n    case 'set-device':\n        flow.set('refresh.device', Number(msg.payload))\n        break;\n\n    case 'refresh':\n        { const deviceId = flow.get('refresh.device')\n\n          if (deviceId) {\n              return { \n                  topic: 'get-cards',\n                  payload: { deviceId:deviceId } \n              }\n          }\n        }\n        break\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 270,
        "y": 780,
        "wires": [
            [
                "196e0519.9c92cb"
            ]
        ]
    },
    {
        "id": "33497a02.770536",
        "type": "debug",
        "z": "2a36b650.4b9b7a",
        "name": "card@",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 690,
        "y": 1000,
        "wires": []
    },
    {
        "id": "db72adb4.36261",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 135,
        "y": 760,
        "wires": [
            [
                "920606cd.352758"
            ]
        ]
    },
    {
        "id": "13f668be.c2e417",
        "type": "get-card-by-index",
        "z": "2a36b650.4b9b7a",
        "name": "get-card-by-index",
        "topic": "get-card-by-index",
        "config": "cbd92359.dbf19",
        "x": 490,
        "y": 900,
        "wires": [
            [
                "4098b71e.12c1b8"
            ],
            [
                "33497a02.770536",
                "de510a21.addef8"
            ]
        ]
    },
    {
        "id": "d435a504.9295d8",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "delete-cards",
        "func": "switch (msg.topic) {\n    case 'set-device':\n        flow.set('delete-cards.device', msg.payload)\n        break;\n\n    case 'delete-cards':\n        const deviceId = flow.get('delete-cards.device')\n\n        if (deviceId) {\n            msg.payload = { \n                deviceId: deviceId\n            }\n        \n            return msg\n        }\n        break        \n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 290,
        "y": 1340,
        "wires": [
            [
                "874f55c6.6f00b8"
            ]
        ]
    },
    {
        "id": "3b1532d.e15adce",
        "type": "debug",
        "z": "2a36b650.4b9b7a",
        "name": "deleted",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 1300,
        "wires": []
    },
    {
        "id": "12b53ea2.d23791",
        "type": "ui_button",
        "z": "2a36b650.4b9b7a",
        "name": "delete-cards",
        "group": "975ca31.d8d236",
        "order": 4,
        "width": 2,
        "height": 2,
        "passthru": false,
        "label": "delete all",
        "tooltip": "Deletes all cards",
        "color": "#C00000",
        "bgcolor": "#F3B567",
        "icon": "",
        "payload": "",
        "payloadType": "date",
        "topic": "delete-cards",
        "x": 90,
        "y": 1360,
        "wires": [
            [
                "d435a504.9295d8"
            ]
        ]
    },
    {
        "id": "36bef050.3e6b9",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 135,
        "y": 1320,
        "wires": [
            [
                "d435a504.9295d8"
            ]
        ]
    },
    {
        "id": "d5e17469.7208d8",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "deleted",
        "func": "if (msg.payload.deleted) {\n    msg.payload = 'card deleted'\n} else {\n    msg.payload = 'error deleting card'\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 700,
        "y": 1340,
        "wires": [
            []
        ]
    },
    {
        "id": "874f55c6.6f00b8",
        "type": "delete-all-cards",
        "z": "2a36b650.4b9b7a",
        "name": "delete-all-cards",
        "config": "cbd92359.dbf19",
        "x": 480,
        "y": 1340,
        "wires": [
            [
                "d5e17469.7208d8",
                "3b1532d.e15adce"
            ]
        ]
    },
    {
        "id": "cb614bbf.65eb68",
        "type": "comment",
        "z": "2a36b650.4b9b7a",
        "name": "detail page: card record count",
        "info": "",
        "x": 160,
        "y": 140,
        "wires": []
    },
    {
        "id": "d5de73fc.318b9",
        "type": "link out",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "f8233afa.37a5c8"
        ],
        "x": 795,
        "y": 440,
        "wires": []
    },
    {
        "id": "4ce6edf2.3af724",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "status",
        "func": "const status = { topic: msg.topic, payload: msg.payload.status.message }\nlet card = null\n\nif (msg.payload.status.code !== 0) {\n   card = { \n       topic: msg.topic,\n       payload: { \n           card: { \n               number: '', \n               valid: { \n                   from: '', \n                   to: '' \n                   \n               }, \n               doors: { \n                   1: '', \n                   2: '', \n                   3: '', \n                   4: '' \n                   \n               } \n           }\n           \n       }\n   }\n}\n\nreturn [ status, card ]",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 650,
        "y": 460,
        "wires": [
            [
                "d5de73fc.318b9"
            ],
            [
                "75f21b8.86ccbe4"
            ]
        ]
    },
    {
        "id": "ba97d2cc.cdc3b",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "a023fb14.897008"
        ],
        "x": 135,
        "y": 40,
        "wires": [
            [
                "cac018fe.0afcf8"
            ]
        ]
    },
    {
        "id": "cac018fe.0afcf8",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "setup",
        "func": "const controllers = msg.payload.controllers\n\nif (controllers) {\n    flow.set('controllers', controllers)\n\n    const options = []\n    Object.entries(controllers).forEach(([k,v]) => {\n      options.push(k) \n    })\n\n    return { \n        topic:'set-controllers', \n        options: options\n    }\n}\n\nreturn null\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 230,
        "y": 40,
        "wires": [
            [
                "92910a57.c53858"
            ]
        ]
    },
    {
        "id": "5198ce10.2b81d",
        "type": "comment",
        "z": "2a36b650.4b9b7a",
        "name": "cards table",
        "info": "",
        "x": 100,
        "y": 320,
        "wires": []
    },
    {
        "id": "3f851cae.42c3e4",
        "type": "inject",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"command\":\"setColumns\",\"arguments\":[[{\"title\":\"card number\",\"field\":\"number\",\"align\":\"left\",\"width\":134},{\"title\":\"from\",\"field\":\"valid.from\",\"align\":\"left\",\"width\":108},{\"title\":\"to\",\"field\":\"valid.to\",\"align\":\"left\",\"width\":108},{\"title\":\"door.1\",\"field\":\"doors.1\",\"align\":\"center\",\"width\":100,\"formatter\":\"tickCross\"},{\"title\":\"door.2\",\"field\":\"doors.2\",\"align\":\"center\",\"width\":100,\"formatter\":\"tickCross\"},{\"title\":\"door.3\",\"field\":\"doors.3\",\"align\":\"center\",\"width\":100,\"formatter\":\"tickCross\"},{\"title\":\"door.4\",\"field\":\"doors.4\",\"align\":\"center\",\"width\":100,\"formatter\":\"tickCross\"}]]}",
        "payloadType": "json",
        "x": 970,
        "y": 840,
        "wires": [
            [
                "32cd75ea.8b84ba"
            ]
        ]
    },
    {
        "id": "e825163c.2e4f18",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "doors",
        "func": "const controllers = flow.get('controllers')\nconst deviceId = msg.payload\n\nif (controllers && controllers[deviceId]) {\n    const device = controllers[deviceId]\n    const columns = {\n        \"command\": \"setColumns\",\n        \"arguments\": [\n            [\n                {\n                    \"title\": \"card number\",\n                    \"field\": \"number\",\n                    \"align\": \"left\",\n                    \"width\": 134\n                },\n                {\n                    \"title\": \"from\",\n                    \"field\": \"valid.from\",\n                    \"align\": \"left\",\n                    \"width\": 108\n                },\n                {\n                    \"title\": \"to\",\n                    \"field\": \"valid.to\",\n                    \"align\": \"left\",\n                    \"width\": 108\n                },\n                {\n                    \"title\": device.doors[1],\n                    \"field\": \"doors.1\",\n                    \"align\": \"center\",\n                    \"width\": 100,\n                    \"formatter\": \"tickCross\"\n                },\n                {\n                    \"title\": device.doors[2],\n                    \"field\": \"doors.2\",\n                    \"align\": \"center\",\n                    \"width\": 100,\n                    \"formatter\": \"tickCross\"\n                },\n                {\n                    \"title\": device.doors[3],\n                    \"field\": \"doors.3\",\n                    \"align\": \"center\",\n                    \"width\": 100,\n                    \"formatter\": \"tickCross\"\n                },\n                {\n                    \"title\": device.doors[4],\n                    \"field\": \"doors.4\",\n                    \"align\": \"center\",\n                    \"width\": 100,\n                    \"formatter\": \"tickCross\"\n                }\n            ]\n        ]\n    }\n    \n    return { topic:'set-doors',  payload: columns }\n}\n\nreturn null\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 970,
        "y": 880,
        "wires": [
            [
                "32cd75ea.8b84ba"
            ]
        ]
    },
    {
        "id": "11c70f5e.08eca1",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 835,
        "y": 880,
        "wires": [
            [
                "e825163c.2e4f18"
            ]
        ]
    },
    {
        "id": "aa152261.eb314",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "list-cards",
        "func": "const map = flow.get('cards') || new Map()\nconst list = []\n\nconsole.log(msg)\n\nif (msg.payload) {\n    const deviceId = Number(msg.payload)\n    const cards = map.get(deviceId) || new Map()\n\n    console.log('gotcha', deviceId, cards)\n    \n    for (const [k,v] of cards) {\n        list.push(v)\n    }\n}\n\nreturn {\n    topic: 'list-cards',\n    payload: {\n        'command': 'setData',\n        'arguments': [ list, false ]\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 960,
        "y": 960,
        "wires": [
            [
                "32cd75ea.8b84ba"
            ]
        ]
    },
    {
        "id": "51859f2a.5f682",
        "type": "link in",
        "z": "2a36b650.4b9b7a",
        "name": "",
        "links": [
            "fe2f6f7f.53fd9"
        ],
        "x": 835,
        "y": 920,
        "wires": [
            [
                "aa152261.eb314"
            ]
        ]
    },
    {
        "id": "de510a21.addef8",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "add-card",
        "func": "const deviceId = msg.payload.deviceId\nconst card = msg.payload.card\n\nconst map = flow.get('cards') || new Map()\nconst cards = map.get(deviceId) || new Map()\n\nif (card.number !== '') {\n    cards.set(card.number, card)\n    map.set(deviceId, cards)\n\n    flow.set('cards', map)\n}\n\nreturn { \n    topic: 'updated',\n    payload: deviceId\n}\n    \n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 700,
        "y": 960,
        "wires": [
            [
                "aa152261.eb314",
                "e15d01a.96f34"
            ]
        ]
    },
    {
        "id": "a6377ea9.6a093",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "refresh-setup",
        "func": "const deviceId = msg.payload.deviceId\nconst count = msg.payload.cards\nconst map = flow.get('cards') || new Map()\n\nif (deviceId) {\n    map.set(deviceId, new Map())\n              \n    flow.set('refresh.count', msg.payload.cards)\n    flow.set('refresh.index', 0)\n    flow.set('cards', map)\n\n    return {\n        topic: 'get-next', \n        payload: true\n    }\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 130,
        "y": 900,
        "wires": [
            [
                "e15d01a.96f34"
            ]
        ]
    },
    {
        "id": "e15d01a.96f34",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "get-next",
        "func": "const deviceId = flow.get('refresh.device')\nconst count = flow.get('refresh.count') || 0\nconst index = flow.get('refresh.index') || 0\nconst map = flow.get('cards') || new Map()\n        \nif (deviceId) {\n    const cards = map.get(deviceId) || new Map()\n\n    if (cards.size < count) {\n        next = index + 1\n        flow.set('refresh.index', next)\n        return {\n            topic:'get-card-by-index', \n            payload: { \n                deviceId:deviceId, \n                index:next \n            } \n        }\n    }\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 300,
        "y": 900,
        "wires": [
            [
                "13f668be.c2e417"
            ]
        ]
    },
    {
        "id": "4098b71e.12c1b8",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "not-found?",
        "func": "if (msg.payload.status.code !== 0) {\n    return { \n        topic: 'get-next',\n        payload: true\n    }\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 710,
        "y": 840,
        "wires": [
            [
                "e15d01a.96f34"
            ]
        ]
    },
    {
        "id": "9b0040b6.02d8c",
        "type": "ui_ui_control",
        "z": "2a36b650.4b9b7a",
        "name": "tab-event",
        "events": "change",
        "x": 320,
        "y": 1040,
        "wires": [
            [
                "6df1685e.0d8448"
            ]
        ]
    },
    {
        "id": "6df1685e.0d8448",
        "type": "function",
        "z": "2a36b650.4b9b7a",
        "name": "initialise-list",
        "func": "if ((msg.payload === 'change') && (typeof msg.tab !== \"undefined\") && (msg.name === 'cards')) {\n      const deviceId = flow.get('refresh.device')\n      \n      if (deviceId) {\n          msg.payload = deviceId\n          \n          return msg;\n      }\n}\n\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 510,
        "y": 1040,
        "wires": [
            [
                "4451de5a.3d5ea"
            ]
        ]
    },
    {
        "id": "4451de5a.3d5ea",
        "type": "delay",
        "z": "2a36b650.4b9b7a",
        "name": "delay",
        "pauseType": "delay",
        "timeout": "500",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 690,
        "y": 1040,
        "wires": [
            [
                "aa152261.eb314"
            ]
        ]
    },
    {
        "id": "573f9bfa.7e4564",
        "type": "ui_group",
        "z": "",
        "name": "column-2",
        "tab": "2731970.74c476a",
        "order": 3,
        "disp": false,
        "width": "5",
        "collapse": false
    },
    {
        "id": "cbd92359.dbf19",
        "type": "config",
        "z": "",
        "name": "demo",
        "timeout": "5000",
        "bind": "192.168.1.100",
        "broadcast": "192.168.1.255:60000",
        "listen": "192.168.1.100:60001",
        "controllers": "{\"303986753\":{\"address\":\"192.168.1.100:60000\"},\"405419896\":{\"address\":\"192.168.1.100:60000\"}}",
        "debug": true
    },
    {
        "id": "975ca31.d8d236",
        "type": "ui_group",
        "z": "",
        "name": "cards",
        "tab": "bb81af8b.a4ff7",
        "order": 1,
        "disp": false,
        "width": "14",
        "collapse": false
    },
    {
        "id": "80ebf5dd.1d2018",
        "type": "ui_group",
        "z": "",
        "name": "card",
        "tab": "bb81af8b.a4ff7",
        "order": 2,
        "disp": false,
        "width": 6,
        "collapse": false
    },
    {
        "id": "2731970.74c476a",
        "type": "ui_tab",
        "z": "",
        "name": "detail",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    },
    {
        "id": "bb81af8b.a4ff7",
        "type": "ui_tab",
        "z": "",
        "name": "cards",
        "icon": "dashboard",
        "disabled": false,
        "hidden": false
    }
]