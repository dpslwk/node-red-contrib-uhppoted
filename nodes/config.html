<script type="text/javascript">
    RED.nodes.registerType('config',{
        category: 'config',
        color: '#FDF0C2',
        defaults: {
            name: { 
                value: "" 
            },
            timeout: { 
                value: 5000,      
                validate: RED.validators.number() 
            },
            bind: { 
                value: "0.0.0.0", 
                validate: RED.validators.regex(/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/) 
            },
            broadcast: { 
                value: "255.255.255.255", 
                validate: RED.validators.regex(/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}/) 
            },
            listen: { 
                value: "0.0.0.0:60000", 
                validate: RED.validators.regex(/[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:[0-9]+/) 
            },
            controllers: { 
                value: "{}", 
            },
            debug: { 
                value: false, 
            },
        },

        label: function() {
            return this.name || "config";
        },

        oneditprepare: function () {
            const table = document.getElementById('node-config-input-controllers-editor')

            if (table) {
                table.querySelector('#add').onclick = event => { 
                    addRow(table, { id: '', address: '' })
                }

                try {
                    const object = Object.entries(JSON.parse(this.controllers || '{}'))
                    const devices = object.sort((a, b) => a[0] - b[0])

                    for (const [k, v] of devices) {
                        addRow(table, { id: `${k}`, address: v.address })
                    }
                } catch (err) { 
                    console.log(err)
                }
            }
        },

        oneditsave: function () {
            const table = document.getElementById('node-config-input-controllers-editor')

            if (table) {
                const object = {}
                const rows = table.rows

                for (let i=1; i < rows.length; i++) {
                    try {
                        const device = rows[i].cells[0].querySelector('input')
                        const address = rows[i].cells[1].querySelector('input')

                        if (device && address) {
                            const id = device.value.trim()
                            const addr = address.value.trim()

                            if (/^[0-9]+$/.test(id) && /^(.*?)(?::([0-9]+))?$/.test(addr)) {
                                object[id] = { address: addr }
                            }                            
                        }
                    } catch (err) { 
                        console.log(err)
                    }
                }

                this.controllers = JSON.stringify(object)
            }
        },

    });

function addRow (table, controller) {
    const tbody = table.querySelector('tbody')
    const row = tbody.insertRow()
    const c1  = row.insertCell()
    const c2  = row.insertCell()
    const device = document.createElement('input')
    const address = document.createElement('input')

    row.style.border = '1px solid grey'

    c1.style.border = '1px solid grey'
    c2.style.border = '1px solid grey'

    device.type = 'number'
    device.style.width = '100%'
    device.style.border = 'none'
    device.value = controller.id || ''
    device.placeholder = '405419896'

    address.type = 'text'
    address.style.width = '100%'
    address.style.border = 'none'
    address.value = controller.address || ''
    address.placeholder = '192.168.1.100:60000'
                
    c1.appendChild(device)
    c2.appendChild(address)
}
</script>

<script type="text/html" data-template-name="config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i>Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <label for="node-config-input-timeout"><i class="fa fa-tag"></i>Timeout</label>
        <input type="text" id="node-config-input-timeout" placeholder="5000" />
    </div>
    <div class="form-row">
        <label for="node-config-input-bind"><i class="fa fa-tag"></i>Bind address</label>
        <input type="text" id="node-config-input-bind" placeholder="0.0.0.0" />
    </div>
    <div class="form-row">
        <label for="node-config-input-broadcast"><i class="fa fa-tag"></i>Broadcast address</label>
        <input type="text" id="node-config-input-broadcast" placeholder="255.255.255.255" />
    </div>
    <div class="form-row">
        <label for="node-config-input-listen"><i class="fa fa-tag"></i>Listen address</label>
        <input type="text" id="node-config-input-listen" placeholder="0.0.0.0:60000" />
    </div>
    <div class="form-row">
        <label for="node-config-input-debug"><i class="fa fa-tag"></i>Debug</label>
        <input type="checkbox" id="node-config-input-debug" placeholder="false" />
    </div>
    <div class="form-row">
        <label for="node-config-input-controllers-editor"><i class="fa fa-tag"></i>Controllers</label>
        <table id="node-config-input-controllers-editor" style="margin-left:16px; border:none; border-collapse:collapse;">
            <thead>
                <tr style="border:none;">
                    <th style="font-weight: normal; font-style:italic; border:1px solid grey;">controller</th>
                    <th style="font-weight: normal; font-style:italic; border:1px solid grey;">address:port</th>
                    <th style="border:none"><i id="add" class="fa fa-plus fa-1x" style="padding:2px 4px 2px 4px;"></i></th>
                </tr>
            </thead>
            <tbody />
        </table>
    </div>
</script>

<script type="text/html" data-help-name="config">
    <p>Configuration node for shared node properties.</p>

    <h3>Properties</h3>
    <dl class="message-properties">
        <dt>name<span class="property-type">string</span></dt>
        <dd>Configuration name</dd>
        <dt>timeout<span class="property-type">uint32</span></dt>
        <dd>Maximum time (in milliseconds) to wait for a reply. Defaults to 5000ms</dd>
        <dt>bind<span class="property-type">IPv4 address</span></dt>
        <dd>IPv4 address to which to bind on systems which have multiple interfaces. Defaults to 0.0.0.0</dd>
        <dt>broadcast<span class="property-type">IPv4 address</span></dt>
        <dd>IPv4 address to which to broadcast UDP messages. Defaults to 255.255.255.255</dd>
        <dt>listen<span class="property-type">address:port</span></dt>
        <dd>IPv4 address and port on which to listen for controller events. Defaults to 0.0.0.0:60000</dd>
        <dt>controllers<span class="property-type">array</span></dt>
        <dd>List of access controllers with specific IP addresses</dd>
        <dt>debug<span class="property-type">boolean</span></dt>
        <dd>Enables logging controller requests/responses to the console</dd>
    </dl>

    <h3>Details</h3>
    <p><code>bind</code> and <code>broadcast</code> configuration values are not generally required
    for operation on the local LAN, unless the host has multiple interfaces and it is desirable to 
    restrict UDP broadcasts to a single interface. Access controllers that are not on the local LAN
    will not receive UDP broadcasts and it is necessary to specify the actual IP address of the
    controller for requests.</p>

    <p>The <code>listen</code> <code>address:port</code> configuration values should match the 
    configuration used by the access controllers (as configured with <code>set-listen-address</code>).

    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/uhppoted">uhppoted</a>: GitHub umbrella project</li>
        <li><a href="https://github.com/uhppoted/node-red-contrib-uhppoted">node-red-contrib-uhppoted</a>: GitHub project</li>
    </ul>
</script>
